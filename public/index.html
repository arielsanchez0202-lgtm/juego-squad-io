<!DOCTYPE html>
<html>
<head>
    <title>SQUAD IO</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* PANTALLA DE SELECCIÓN */
        #selector { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 10; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; 
        }
        .card-container { display: flex; gap: 20px; }
        .card { 
            width: 200px; padding: 20px; background: #222; border: 2px solid #555; 
            border-radius: 10px; cursor: pointer; transition: 0.3s; text-align: center;
        }
        .card:hover { transform: scale(1.1); border-color: white; background: #333; }
        .card h2 { margin: 0; }
        .card p { color: #aaa; font-size: 14px; }
        .card.tank { border-color: #3498db; }
        .card.sniper { border-color: #f1c40f; }
        .card.medic { border-color: #2ecc71; }

        /* HUD JUEGO */
        #hud { display: none; position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .stats-box { position: absolute; top: 20px; left: 20px; font-size: 18px; text-shadow: 2px 2px 0 #000; }
        .boss-bar-cont { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 600px; height: 25px; background: #333; border: 2px solid #fff; border-radius: 12px; overflow: hidden; }
        .boss-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.2s; }
        
        #aviso { position: absolute; top: 30%; width: 100%; text-align: center; font-size: 40px; font-weight: bold; color: white; text-shadow: 0 0 20px red; }
    </style>
</head>
<body>

    <div id="selector">
        <h1>ELIGE TU ROL</h1>
        <div class="card-container">
            <div class="card tank" onclick="elegir('tanque')">
                <h2 style="color:#3498db">TANQUE</h2>
                <p>HP ALTA - LENTO<br>Escudo del equipo</p>
            </div>
            <div class="card sniper" onclick="elegir('sniper')">
                <h2 style="color:#f1c40f">SNIPER</h2>
                <p>DAÑO EXTREMO<br>Disparo lento y lejano</p>
            </div>
            <div class="card medic" onclick="elegir('medico')">
                <h2 style="color:#2ecc71">MÉDICO</h2>
                <p>SOPORTE<br>Dispara a aliados para CURAR</p>
            </div>
        </div>
    </div>

    <div id="hud">
        <div class="boss-bar-cont"><div class="boss-fill" id="bossBar"></div></div>
        <div class="stats-box">
            ROL: <span id="rolDisplay">---</span><br>
            HP: <span id="hp">0</span><br>
            DINERO: $<span id="score">0</span><br>
            <small>Presiona 1 para Daño ($150) | 2 para Motor ($100)</small>
        </div>
        <div id="aviso"></div>
    </div>

    <canvas id="gameCanvas" width="1200" height="800"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let me = {};
        let jugando = false;
        
        // INPUTS
        let teclas = {};
        window.addEventListener('keydown', e => {
            if(!jugando) return;
            teclas[e.key.toLowerCase()] = true;
            if(e.key === '1') socket.emit('comprar', 'dano');
            if(e.key === '2') socket.emit('comprar', 'speed');
        });
        window.addEventListener('keyup', e => teclas[e.key.toLowerCase()] = false);
        
        canvas.addEventListener('mousedown', e => {
            if(!jugando) return;
            const r = canvas.getBoundingClientRect();
            socket.emit('disparar', Math.atan2(e.clientY - r.top - me.y, e.clientX - r.left - me.x));
        });

        // LÓGICA DE SELECCIÓN
        function elegir(clase) {
            socket.emit('elegirClase', clase);
            document.getElementById('selector').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            jugando = true;
        }

        socket.on('muerte', () => {
            jugando = false;
            document.getElementById('selector').style.display = 'flex'; // Volver a elegir
            document.getElementById('hud').style.display = 'none';
        });

        socket.on('mensajeGlobal', msg => {
            const el = document.getElementById('aviso');
            el.innerText = msg;
            setTimeout(() => el.innerText = "", 3000);
        });

        socket.on('estado', estado => {
            // UI BOSS
            const bossPct = (estado.jefe.hp / estado.jefe.maxHp) * 100;
            document.getElementById('bossBar').style.width = Math.max(0, bossPct) + "%";

            // UI PLAYER
            if(estado.jugadores[socket.id]) {
                me = estado.jugadores[socket.id];
                document.getElementById('hp').innerText = Math.floor(me.hp);
                document.getElementById('score').innerText = me.score;
                document.getElementById('rolDisplay').innerText = me.clase ? me.clase.toUpperCase() : "ESPECTADOR";
            }

            // RENDER
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width, canvas.height); // Fondo

            // Jefe
            const b = estado.jefe;
            if(b.hp > 0){
                ctx.beginPath(); ctx.arc(b.x, b.y, b.radio, 0, Math.PI*2);
                ctx.fillStyle = b.color; ctx.fill();
                ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.stroke();
            }

            // Jugadores
            for(let id in estado.jugadores){
                let p = estado.jugadores[id];
                if(!p.clase) continue; // No dibujar a los que están eligiendo
                ctx.beginPath(); ctx.arc(p.x, p.y, p.radio, 0, Math.PI*2);
                ctx.fillStyle = p.color; ctx.fill();
                // Barra Vida Mini
                ctx.fillStyle = '#f00'; ctx.fillRect(p.x-15, p.y-30, 30, 5);
                ctx.fillStyle = '#0f0'; ctx.fillRect(p.x-15, p.y-30, (Math.max(0, p.hp)/p.maxHp)*30, 5);
            }

            // Balas
            estado.balas.forEach(ba => {
                ctx.beginPath(); ctx.arc(ba.x, ba.y, ba.radio, 0, Math.PI*2);
                ctx.fillStyle = ba.color; ctx.fill();
            });

            // Movimiento
            if(jugando && me.clase) {
                let v = me.velocidad;
                if(teclas['w']) socket.emit('movimiento', {x: me.x, y: me.y - v});
                if(teclas['s']) socket.emit('movimiento', {x: me.x, y: me.y + v});
                if(teclas['a']) socket.emit('movimiento', {x: me.x - v, y: me.y});
                if(teclas['d']) socket.emit('movimiento', {x: me.x + v, y: me.y});
            }
        });
    </script>
</body>
</html>